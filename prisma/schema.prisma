// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String     @id @default(cuid())
  name          String
  username      String     @unique
  email         String     @unique
  passwordHash  String
  bio           String?
  avatarUrl     String?

  posts         Post[]
  comments      Comment[]
  Likes         Like[]
  media         Media[]
  bookmarks     Bookmark[]
  

  // followers: users who follow THIS user
  followers     Follow[]   @relation("followers")
  // following: users THIS user follows
  following     Follow[]   @relation("following")

  sessions      Session[]

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

// Session table (used for custom JWT or NextAuth)
model Session {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  token     String   @unique
  expiresAt DateTime
}

// ------------------------------------------------------
// POSTS & CONTENT
// ------------------------------------------------------

model Post {
  id             String        @id @default(cuid())
  title          String
  slug           String        @unique
  content        String
  excerpt        String?
  coverImageUrl  String?
  isPublished    Boolean       @default(false)
  publishedAt    DateTime?
  author         User          @relation(fields: [authorId], references: [id])
  authorId       String

  tags           PostTag[]
  comments       Comment[]
  Likes          Like[]
  bookmarks      Bookmark[]

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

// ------------------------------------------------------
// TAGS
// ------------------------------------------------------

model Tag {
  id       String     @id @default(cuid())
  name     String     @unique
  slug     String     @unique

  posts    PostTag[]
}

// Many-to-many linking posts ↔ tags
model PostTag {
  id     String @id @default(cuid())

  post   Post   @relation(fields: [postId], references: [id])
  postId String

  tag    Tag    @relation(fields: [tagId], references: [id])
  tagId  String

  @@unique([postId, tagId]) // Prevent duplicates
}

// ------------------------------------------------------
// COMMENTS (supports nested replies)
// ------------------------------------------------------

model Comment {
  id         String     @id @default(cuid())
  content    String

  post       Post       @relation(fields: [postId], references: [id])
  postId     String

  author     User       @relation(fields: [authorId], references: [id])
  authorId   String

  parent     Comment?   @relation("CommentReplies", fields: [parentId], references: [id])
  parentId   String?

  replies    Comment[]  @relation("CommentReplies")

  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

// ------------------------------------------------------
// LikeS (Medium-style multiple Likes per user)
// ------------------------------------------------------

model Like {
  id        String   @id @default(cuid())
  post      Post     @relation(fields: [postId], references: [id])
  postId    String

  user      User     @relation(fields: [userId], references: [id])
  userId    String

  count     Int      @default(1) // allow 1-50 Likes
  updatedAt DateTime @updatedAt

  @@unique([postId, userId]) // One record per user per post
}

// ------------------------------------------------------
// FOLLOWING system (user ↔ user)
// ------------------------------------------------------

model Follow {
  id          String @id @default(cuid())

  follower    User   @relation("followers", fields: [followerId], references: [id])
  followerId  String

  following   User   @relation("following", fields: [followingId], references: [id])
  followingId String

  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
}

// ------------------------------------------------------
// MEDIA UPLOADS
// ------------------------------------------------------

model Media {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String

  url       String
  type      String // image, video, etc.

  createdAt DateTime @default(now())
}

// ------------------------------------------------------
// BOOKMARKS (user saves post)
// ------------------------------------------------------

model Bookmark {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String

  post      Post     @relation(fields: [postId], references: [id])
  postId    String

  createdAt DateTime @default(now())

  @@unique([userId, postId])
}


